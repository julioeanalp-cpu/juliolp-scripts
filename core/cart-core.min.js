
(function() {
    'use strict';
    
    console.log('ðŸ›’ JulioLP Cart System v2.0 - Inicializando...');
    
    // ========================================================================
    // CONFIGURAÃ‡Ã•ES
    // ========================================================================
    const CONFIG = {
        whatsappNumber: "351919225483",
        checkoutPageUrl: "/p/checkout.html",
        cartStorageKey: "vinylCartComplete",
        version: "2.0"
    };
    
    // ========================================================================
    // ESTADO GLOBAL DO CARRINHO
    // ========================================================================
    if (!window.cartData) {
        window.cartData = { 
            items: [], 
            total: 0, 
            count: 0 
        };
    }
    
    // ========================================================================
    // FUNÃ‡Ã•ES AUXILIARES
    // ========================================================================
    
    /**
     * Carrega o carrinho do localStorage
     */
    function loadCart() {
        try {
            const saved = localStorage.getItem(CONFIG.cartStorageKey);
            if (saved) {
                const parsed = JSON.parse(saved);
                window.cartData = parsed;
                console.log('âœ… Carrinho carregado:', window.cartData.items.length, 'itens');
            }
        } catch (e) {
            console.error('âŒ Erro ao carregar carrinho:', e);
            window.cartData = { items: [], total: 0, count: 0 };
        }
    }
    
    /**
     * Salva o carrinho no localStorage
     */
    function saveCart() {
        try {
            localStorage.setItem(CONFIG.cartStorageKey, JSON.stringify(window.cartData));
            syncWithSimpleCart();
            console.log('ðŸ’¾ Carrinho salvo:', window.cartData.items.length, 'itens');
        } catch (e) {
            console.error('âŒ Erro ao salvar carrinho:', e);
        }
    }
    
    /**
     * Sincroniza com SimpleCart.js (se disponÃ­vel)
     */
    function syncWithSimpleCart() {
        if (typeof simpleCart === 'undefined') return;
        
        try {
            simpleCart.empty();
            window.cartData.items.forEach(item => {
                simpleCart.add({
                    name: item.title,
                    price: item.price,
                    quantity: item.quantity,
                    thumb: item.image,
                    url: item.url
                });
            });
            console.log('ðŸ”„ Sincronizado com SimpleCart');
        } catch (e) {
            console.error('âŒ Erro ao sincronizar com SimpleCart:', e);
        }
    }
    
    /**
     * Atualiza os totais do carrinho
     */
    function updateCartTotals() {
        window.cartData.count = 0;
        window.cartData.total = 0;
        
        window.cartData.items.forEach(item => {
            window.cartData.count += item.quantity;
            window.cartData.total += item.price * item.quantity;
        });
        
        console.log('ðŸ“Š Totais atualizados - Itens:', window.cartData.count, 'Total: â‚¬' + window.cartData.total.toFixed(2));
    }
    
    /**
     * Atualiza a interface do carrinho
     */
    function updateCartUI() {
        const countEl = document.getElementById('cartCount');
        const itemsEl = document.getElementById('cartItems');
        const footerEl = document.getElementById('cartFooter');
        const subtotalEl = document.getElementById('cartSubtotal');
        
        // Atualiza contador no Ã­cone do carrinho
        if (countEl) {
            countEl.textContent = window.cartData.count;
            countEl.style.display = window.cartData.count > 0 ? 'flex' : 'none';
        }
        
        // Se carrinho vazio
        if (window.cartData.items.length === 0) {
            if (footerEl) footerEl.style.display = 'none';
            if (itemsEl) {
                itemsEl.innerHTML = `
                    <div class="cart-empty">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Seu carrinho estÃ¡ vazio</p>
                    </div>
                `;
            }
            console.log('ðŸ“­ Carrinho vazio');
            return;
        }
        
        // Mostra footer e renderiza itens
        if (footerEl) footerEl.style.display = 'block';
        
        let itemsHtml = '';
        window.cartData.items.forEach(item => {
            itemsHtml += `
                <div class="cart-item" data-item-id="${item.id}">
                    <div class="cart-item-image">
                        <img src="${item.image}" 
                             alt="${escapeHtml(item.title)}" 
                             loading="lazy" 
                             onerror="this.src='https://via.placeholder.com/80x80/d4af37/1a1a1a?text=Vinil'">
                    </div>
                    <div class="cart-item-details">
                        <div class="cart-item-title">${escapeHtml(item.title)}</div>
                        <div class="cart-item-artist">${escapeHtml(item.artist)}</div>
                        <div class="cart-item-price">â‚¬${item.price.toFixed(2)}</div>
                        <div class="cart-item-quantity">
                            <button onclick="updateQuantity(${item.id}, -1)" class="qty-btn" aria-label="Diminuir quantidade">âˆ’</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)" class="qty-btn" aria-label="Aumentar quantidade">+</button>
                        </div>
                    </div>
                    <button class="cart-item-remove" 
                            onclick="removeFromCart(${item.id})" 
                            aria-label="Remover do carrinho">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        });
        
        if (itemsEl) itemsEl.innerHTML = itemsHtml;
        if (subtotalEl) subtotalEl.textContent = 'â‚¬' + window.cartData.total.toFixed(2);
        
        console.log('ðŸŽ¨ Interface atualizada');
    }
    
    /**
     * Escapa HTML para prevenir XSS
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    /**
     * Extrai informaÃ§Ãµes do produto do card
     */
    function extractProductInfo(button) {
        const card = button.closest('.product-card');
        if (!card) {
            console.warn('âš ï¸ Card nÃ£o encontrado');
            return null;
        }
        
        const titleEl = card.querySelector('.product-title, .product-title a');
        const priceEl = card.querySelector('.product-price');
        
        if (!titleEl || !priceEl) {
            console.warn('âš ï¸ Elementos do produto nÃ£o encontrados');
            return null;
        }
        
        const fullTitle = titleEl.textContent.trim();
        let title = fullTitle;
        let artist = 'Artista';
        
        // Extrai artista se o tÃ­tulo tiver formato "Artista - TÃ­tulo"
        if (fullTitle.includes(' - ')) {
            const parts = fullTitle.split(' - ');
            artist = parts[0].trim();
            title = parts.slice(1).join(' - ').trim();
        }
        
        return {
            title: title,
            artist: artist,
            price: parseFloat(priceEl.getAttribute('data-price')) || 15.00,
            image: card.querySelector('.product-thumb, img')?.src || '',
            url: button.getAttribute('data-url') || titleEl.href || '#'
        };
    }
    
    /**
     * Extrai informaÃ§Ãµes do produto da pÃ¡gina single
     */
    function extractSingleProductInfo(button) {
        const container = button.closest('.product-single-container') || document.querySelector('.product-single-container');
        if (!container) {
            console.warn('âš ï¸ Container do produto nÃ£o encontrado');
            return null;
        }
        
        const titleEl = container.querySelector('.product-info-area h1, h1');
        const priceEl = container.querySelector('.product-price-value');
        
        if (!titleEl || !priceEl) {
            console.warn('âš ï¸ Elementos do produto single nÃ£o encontrados');
            return null;
        }
        
        const fullTitle = titleEl.textContent.trim().replace(/\s+/g, ' ');
        let title = fullTitle;
        let artist = 'Artista';
        
        // Extrai artista se o tÃ­tulo tiver formato "Artista - TÃ­tulo"
        if (fullTitle.includes(' - ')) {
            const parts = fullTitle.split(' - ');
            artist = parts[0].trim();
            title = parts.slice(1).join(' - ').trim();
        }
        
        return {
            title: title,
            artist: artist,
            price: parseFloat(priceEl.getAttribute('data-price')) || 15.00,
            image: container.querySelector('.product-main-image img, .product-image img')?.src || '',
            url: window.location.href
        };
    }
    
    // ========================================================================
    // FUNÃ‡Ã•ES PÃšBLICAS DO CARRINHO
    // ========================================================================
    
    /**
     * Adiciona produto ao carrinho (usado nos cards de produtos)
     */
    window.addToCart = function(button) {
        console.log('ðŸ›’ Adicionando ao carrinho...');
        
        const productInfo = extractProductInfo(button);
        if (!productInfo) {
            console.error('âŒ NÃ£o foi possÃ­vel obter informaÃ§Ãµes do produto');
            return;
        }
        
        const existingItem = window.cartData.items.find(item => item.title === productInfo.title);
        
        if (existingItem) {
            existingItem.quantity++;
            console.log('âœ… Quantidade aumentada:', productInfo.title);
        } else {
            window.cartData.items.push({
                id: Date.now(),
                ...productInfo,
                quantity: 1
            });
            console.log('âœ… Produto adicionado:', productInfo.title);
        }
        
        updateCartTotals();
        saveCart();
        updateCartUI();
        
        // Feedback visual
        showNotification('Produto adicionado ao carrinho!', 'success');
    };
    
    /**
     * Adiciona produto ao carrinho (usado na pÃ¡gina single do produto)
     */
    window.addToCartSingle = function(button) {
        console.log('ðŸ›’ Adicionando produto single ao carrinho...');
        
        const productInfo = extractSingleProductInfo(button);
        if (!productInfo) {
            console.error('âŒ NÃ£o foi possÃ­vel obter informaÃ§Ãµes do produto');
            return false;
        }
        
        const existingItem = window.cartData.items.find(item => item.title === productInfo.title);
        
        if (!existingItem) {
            window.cartData.items.push({
                id: Date.now(),
                ...productInfo,
                quantity: 1
            });
            console.log('âœ… Produto single adicionado:', productInfo.title);
        } else {
            console.log('â„¹ï¸ Produto jÃ¡ estÃ¡ no carrinho:', productInfo.title);
        }
        
        updateCartTotals();
        saveCart();
        updateCartUI();
        
        return true;
    };
    
    /**
     * Remove produto do carrinho
     */
    window.removeFromCart = function(id) {
        console.log('ðŸ—‘ï¸ Removendo do carrinho:', id);
        
        const item = window.cartData.items.find(item => item.id === id);
        if (item) {
            window.cartData.items = window.cartData.items.filter(item => item.id !== id);
            console.log('âœ… Produto removido:', item.title);
            
            updateCartTotals();
            saveCart();
            updateCartUI();
            
            showNotification('Produto removido do carrinho', 'info');
        }
    };
    
    /**
     * Atualiza quantidade de um produto
     */
    window.updateQuantity = function(id, change) {
        const item = window.cartData.items.find(item => item.id === id);
        if (!item) return;
        
        item.quantity += change;
        
        if (item.quantity <= 0) {
            window.removeFromCart(id);
        } else {
            console.log('ðŸ“Š Quantidade atualizada:', item.title, 'â†’', item.quantity);
            updateCartTotals();
            saveCart();
            updateCartUI();
        }
    };
    
    /**
     * Abre o carrinho
     */
    window.openCart = function() {
        const cartSidebar = document.getElementById('cartSidebar');
        const cartOverlay = document.getElementById('cartOverlay');
        
        if (cartSidebar && cartOverlay) {
            cartSidebar.classList.add('active');
            cartOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('âœ… Carrinho aberto');
        }
    };
    
    /**
     * Fecha o carrinho
     */
    window.closeCart = function() {
        const cartSidebar = document.getElementById('cartSidebar');
        const cartOverlay = document.getElementById('cartOverlay');
        
        if (cartSidebar && cartOverlay) {
            cartSidebar.classList.remove('active');
            cartOverlay.classList.remove('active');
            document.body.style.overflow = '';
            console.log('âœ… Carrinho fechado');
        }
    };
    
    /**
     * Toggle do carrinho
     */
    window.toggleCart = function() {
        const cartSidebar = document.getElementById('cartSidebar');
        if (cartSidebar && cartSidebar.classList.contains('active')) {
            window.closeCart();
        } else {
            window.openCart();
        }
    };
    
    /**
     * Vai para pÃ¡gina de checkout
     */
    window.goToCheckout = function() {
        if (window.cartData.items.length === 0) {
            alert('Seu carrinho estÃ¡ vazio!');
            return;
        }
        
        saveCart();
        window.location.href = CONFIG.checkoutPageUrl;
    };
    
    /**
     * Comprar agora (adiciona e vai para checkout)
     */
    window.buyNowAndCheckout = function() {
        const button = document.getElementById('addToCartBtn');
        if (!button) {
            alert('BotÃ£o nÃ£o encontrado');
            return;
        }
        
        const success = window.addToCartSingle(button);
        
        if (success) {
            window.goToCheckout();
        } else {
            alert('Ocorreu um erro ao adicionar o produto. Tente novamente.');
        }
    };
    
    /**
     * Checkout via WhatsApp (carrinho completo)
     */
    window.checkoutWhatsApp = function() {
        if (window.cartData.items.length === 0) {
            alert('Seu carrinho estÃ¡ vazio!');
            return;
        }
        
        let msg = 'ðŸŽµ OlÃ¡! Gostaria de encomendar os seguintes discos:\n\n';
        
        window.cartData.items.forEach(item => {
            msg += `*${item.title}*\n`;
            msg += `Quantidade: ${item.quantity}\n`;
            msg += `PreÃ§o: â‚¬${(item.price * item.quantity).toFixed(2)}\n\n`;
        });
        
        msg += `*Total do Pedido: â‚¬${window.cartData.total.toFixed(2)}*`;
        
        const whatsappUrl = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(msg)}`;
        window.open(whatsappUrl, '_blank');
        
        console.log('ðŸ“± WhatsApp aberto para checkout');
    };
    
    /**
     * Comprar via WhatsApp (produto Ãºnico)
     */
    window.buyWhatsAppSingleProduct = function() {
        const productInfo = extractSingleProductInfo(document.querySelector('.product-single-container'));
        if (!productInfo) {
            alert('NÃ£o foi possÃ­vel obter informaÃ§Ãµes do produto');
            return;
        }
        
        const msg = `ðŸŽµ OlÃ¡! Tenho interesse em comprar este disco:\n\n*${productInfo.title}*\nPreÃ§o: â‚¬${productInfo.price.toFixed(2)}\n\nLink do produto: ${productInfo.url}`;
        
        const whatsappUrl = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(msg)}`;
        window.open(whatsappUrl, '_blank');
        
        console.log('ðŸ“± WhatsApp aberto para produto single');
    };
    
    /**
     * Mostra notificaÃ§Ã£o temporÃ¡ria
     */
    function showNotification(message, type = 'info') {
        // Remove notificaÃ§Ãµes anteriores
        const existingNotification = document.querySelector('.cart-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Cria nova notificaÃ§Ã£o
        const notification = document.createElement('div');
        notification.className = `cart-notification cart-notification-${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Mostra com animaÃ§Ã£o
        setTimeout(() => notification.classList.add('show'), 10);
        
        // Remove apÃ³s 3 segundos
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // ========================================================================
    // INICIALIZAÃ‡ÃƒO
    // ========================================================================
    
    /**
     * Inicializa o sistema de carrinho
     */
    function init() {
        console.log('ðŸš€ Inicializando sistema de carrinho...');
        
        // Carrega carrinho
        loadCart();
        
        // Atualiza UI quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateCartUI();
                console.log('âœ… Cart System inicializado com sucesso!');
            });
        } else {
            updateCartUI();
            console.log('âœ… Cart System inicializado com sucesso!');
        }
    }
    
    // Inicia o sistema
    init();
    
    // CSS para notificaÃ§Ãµes (injetado dinamicamente)
    const style = document.createElement('style');
    style.textContent = `
        .cart-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
        }
        
        .cart-notification.show {
            transform: translateX(0);
        }
        
        .cart-notification-success {
            border-left: 4px solid #28a745;
            color: #28a745;
        }
        
        .cart-notification-info {
            border-left: 4px solid #007bff;
            color: #007bff;
        }
        
        .cart-notification-warning {
            border-left: 4px solid #ffc107;
            color: #ffc107;
        }
        
        .cart-notification-error {
            border-left: 4px solid #dc3545;
            color: #dc3545;
        }
    `;
    document.head.appendChild(style);
    
    console.log('ðŸŽ‰ JulioLP Cart System v2.0 carregado com sucesso!');
    
})();
