/* ===== PAGINA√á√ÉO BLOGGER - VITRINE FIXA (SEM SLIDER) ===== */

(function() {
  'use strict';

  // Previne execu√ß√£o duplicada
  if (window.__PAGINATION_READY__) {
    console.warn('‚ö†Ô∏è Pagina√ß√£o j√° foi inicializada');
    return;
  }
  window.__PAGINATION_READY__ = true;

  const CONFIG = {
    POSTS_PER_PAGE: 8,
    MAX_VISIBLE_PAGES: 5,
    BLOGGER_FEED_URL: '/feeds/posts/default'
  };

  // Elementos principais
  const grid = document.getElementById('js-products-grid');
  const paginationContainer = document.getElementById('js-pagination');

  if (!grid || !paginationContainer) {
    console.error('‚ùå Elementos n√£o encontrados:', { grid, paginationContainer });
    return;
  }

  let currentPage = 1;
  let totalPosts = 0;
  let isLoading = false;

  // ============ FUN√á√ïES DE URL ============
  
  function getPageFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const page = parseInt(urlParams.get('page')) || 1;
    return page > 0 ? page : 1;
  }

  function updateUrl(page) {
    const url = new URL(window.location.href);
    if (page === 1) {
      url.searchParams.delete('page');
    } else {
      url.searchParams.set('page', page);
    }
    window.history.pushState({ page }, '', url);
  }

  // ============ FUN√á√ïES DE CARREGAMENTO ============

  function showLoading() {
    grid.innerHTML = `
      <div class="loading-container" style="grid-column: 1/-1; text-align: center; padding: 80px 20px;">
        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #d4c5a0; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <p style="margin-top: 20px; color: #666;">A carregar produtos...</p>
      </div>
    `;
  }

  function showError(message) {
    grid.innerHTML = `
      <div class="error-container" style="grid-column: 1/-1; text-align: center; padding: 80px 20px;">
        <p style="color: #d32f2f; font-size: 16px;">‚ö†Ô∏è ${message}</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer;">Tentar novamente</button>
      </div>
    `;
  }

  // ============ BUSCAR POSTS DO BLOGGER ============

  function fetchBloggerPosts(page) {
    if (isLoading) {
      console.log('‚è≥ J√° est√° a carregar...');
      return;
    }

    isLoading = true;
    currentPage = page;
    showLoading();
    paginationContainer.innerHTML = '';

    const startIndex = (page - 1) * CONFIG.POSTS_PER_PAGE + 1;
    
    // Remove script anterior se existir
    const oldScript = document.getElementById('blogger-feed-script');
    if (oldScript) {
      oldScript.remove();
    }

    // Cria callback √∫nico para esta requisi√ß√£o
    const callbackName = 'bloggerCallback_' + Date.now();
    
    window[callbackName] = function(data) {
      try {
        handleBloggerData(data);
        delete window[callbackName];
      } catch (error) {
        console.error('‚ùå Erro ao processar dados:', error);
        showError('Erro ao processar os dados.');
        isLoading = false;
      }
    };

    // Cria novo script para buscar dados
    const script = document.createElement('script');
    script.id = 'blogger-feed-script';
    script.src = `${CONFIG.BLOGGER_FEED_URL}?alt=json-in-script&max-results=${CONFIG.POSTS_PER_PAGE}&start-index=${startIndex}&callback=${callbackName}`;
    
    script.onerror = function() {
      showError('Erro ao conectar ao servidor.');
      delete window[callbackName];
      isLoading = false;
    };

    document.body.appendChild(script);
  }

  // ============ PROCESSAR DADOS DO BLOGGER ============

  function handleBloggerData(data) {
    console.log('üì¶ Dados recebidos:', data);

    if (!data || !data.feed) {
      showError('Dados inv√°lidos recebidos.');
      isLoading = false;
      return;
    }

    const posts = data.feed.entry || [];
    totalPosts = parseInt(data.feed.openSearch$totalResults.$t) || 0;

    console.log(`üìä Total de posts: ${totalPosts}, Posts nesta p√°gina: ${posts.length}`);

    if (posts.length === 0) {
      grid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 80px 20px;">
          <p style="color: #666; font-size: 16px;">Nenhum produto encontrado nesta p√°gina.</p>
        </div>
      `;
      isLoading = false;
      return;
    }

    // LIMPA COMPLETAMENTE O GRID
    grid.innerHTML = '';

    // Renderiza cada post
    posts.forEach((post, index) => {
      setTimeout(() => {
        renderPost(post);
        
        // Quando renderizar o √∫ltimo post, mostra a pagina√ß√£o
        if (index === posts.length - 1) {
          renderPagination();
          isLoading = false;
        }
      }, index * 50); // Pequeno delay para suavizar a renderiza√ß√£o
    });
  }

  // ============ RENDERIZAR POST ============

  function renderPost(post) {
    const title = post.title.$t || 'Sem t√≠tulo';
    
    // Busca o link correto
    const link = post.link.find(l => l.rel === 'alternate');
    const url = link ? link.href : '#';

    // Busca a imagem
    let imageUrl = 'https://via.placeholder.com/400x400?text=Sem+Imagem';
    if (post.media$thumbnail && post.media$thumbnail.url) {
      imageUrl = post.media$thumbnail.url.replace(/s72-c/, 's400');
    }

    // M√âTODO 1: Processa os labels/categorias do post (Marcadores do Blogger)
    let badgesHTML = '';
    if (post.category && post.category.length > 0) {
      post.category.forEach(cat => {
        const labelText = cat.term;
        // Verifica se o label come√ßa com "off/" (case insensitive)
        if (labelText.toLowerCase().startsWith('off/')) {
          const badgeText = labelText.split('/')[1]; // Pega o texto depois da barra
          badgesHTML += `<span class="product-label label-off">${escapeHtml(badgeText)}</span>`;
        }
      });
    }

    // M√âTODO 2: Processa strikes no conte√∫do do post (para posts antigos)
    if (post.content && post.content.$t) {
      const content = post.content.$t;
      // Procura por <strike>off/TEXTO</strike> no conte√∫do
      const strikeRegex = /<strike[^>]*>off\/([^<]+)<\/strike>/gi;
      let match;
      while ((match = strikeRegex.exec(content)) !== null) {
        const badgeText = match[1].trim();
        badgesHTML += `<span class="product-label label-off">${escapeHtml(badgeText)}</span>`;
      }
    }

    // Se houver badges, cria o wrapper
    const labelsWrapper = badgesHTML ? `<div class="product-labels">${badgesHTML}</div>` : '';

    // Cria o HTML do produto
    const productHTML = `
      <article class="product-card" style="animation: fadeIn 0.3s ease;">
        <div class="product-image">
          <img class="product-thumb" src="${imageUrl}" alt="${escapeHtml(title)}" loading="lazy" 
               onerror="this.src='https://via.placeholder.com/400x400?text=Sem+Imagem'"/>
          
          ${labelsWrapper}
          
          <button class="btn-wishlist" onclick="addToWishlist(this)" aria-label="Adicionar aos favoritos">
            <i class="far fa-heart"></i>
          </button>
          
          <div class="product-overlay">
            <button class="btn-add-cart" data-url="${url}" 
                    onclick="addToCart(this); openCart();" aria-label="Adicionar ao carrinho">
              <i class="fas fa-shopping-cart"></i>
              <span>Adicionar</span>
            </button>
          </div>
        </div>
        
        <div class="product-info">
          <h2 class="product-title allow-copy">
            <a href="${url}">${escapeHtml(title)}</a>
          </h2>
          <div class="product-price" data-price="15.00">‚Ç¨15.00</div>
        </div>
      </article>
    `;

    grid.insertAdjacentHTML('beforeend', productHTML);
  }

  // ============ RENDERIZAR PAGINA√á√ÉO ============

  function renderPagination() {
    const totalPages = Math.ceil(totalPosts / CONFIG.POSTS_PER_PAGE);
    
    console.log(`üìÑ Renderizando pagina√ß√£o: P√°gina ${currentPage} de ${totalPages}`);

    if (totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    paginationContainer.innerHTML = '';

    const maxVisible = CONFIG.MAX_VISIBLE_PAGES;
    let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let end = Math.min(totalPages, start + maxVisible - 1);

    if (end - start < maxVisible - 1) {
      start = Math.max(1, end - maxVisible + 1);
    }

    // Bot√£o "Anterior"
    if (currentPage > 1) {
      createPageButton('‚Äπ', currentPage - 1, 'P√°gina anterior');
    }

    // Primeira p√°gina
    if (start > 1) {
      createPageButton('1', 1, 'Primeira p√°gina');
      if (start > 2) {
        paginationContainer.innerHTML += '<span class="pagination-dots">‚Ä¶</span>';
      }
    }

    // P√°ginas numeradas
    for (let i = start; i <= end; i++) {
      createPageButton(i.toString(), i, `P√°gina ${i}`, i === currentPage);
    }

    // √öltima p√°gina
    if (end < totalPages) {
      if (end < totalPages - 1) {
        paginationContainer.innerHTML += '<span class="pagination-dots">‚Ä¶</span>';
      }
      createPageButton(totalPages.toString(), totalPages, '√öltima p√°gina');
    }

    // Bot√£o "Pr√≥xima"
    if (currentPage < totalPages) {
      createPageButton('‚Ä∫', currentPage + 1, 'Pr√≥xima p√°gina');
    }
  }

  // ============ CRIAR BOT√ÉO DE P√ÅGINA ============

  function createPageButton(text, pageNum, title, isActive = false) {
    const button = document.createElement('a');
    button.href = pageNum === 1 ? window.location.pathname : `?page=${pageNum}`;
    button.textContent = text;
    button.title = title;
    button.className = 'pagination-link' + (isActive ? ' active' : '');
    
    if (!isActive) {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        if (!isLoading && pageNum !== currentPage) {
          goToPage(pageNum);
        }
      });
    }

    paginationContainer.appendChild(button);
  }

  // ============ NAVEGAR PARA P√ÅGINA ============

  function goToPage(page) {
    console.log(`üîÑ Navegando para p√°gina ${page}`);
    updateUrl(page);
    fetchBloggerPosts(page);
    
    // Scroll suave para o topo
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }

  // ============ UTILIT√ÅRIOS ============

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ============ NAVEGA√á√ÉO DO BROWSER ============

  window.addEventListener('popstate', function(event) {
    const page = getPageFromUrl();
    console.log('üîô Navega√ß√£o do browser: p√°gina', page);
    fetchBloggerPosts(page);
  });

  // ============ INICIALIZA√á√ÉO ============

  function initPagination() {
    console.log('üöÄ Inicializando pagina√ß√£o do Blogger...');
    
    // Detecta p√°gina inicial da URL
    currentPage = getPageFromUrl();
    console.log(`üìç P√°gina inicial: ${currentPage}`);
    
    // Carrega os posts
    fetchBloggerPosts(currentPage);
  }

  // Aguarda DOMContentLoaded para garantir que fun√ß√µes do carrinho estejam dispon√≠veis
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPagination);
  } else {
    initPagination();
  }

})();
