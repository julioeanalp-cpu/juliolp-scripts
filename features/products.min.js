(function() { 'use strict'; if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initRelatedProducts); } else { initRelatedProducts(); } function initRelatedProducts() { const relatedContainer = document.getElementById('relatedProducts'); if (!relatedContainer) { console.log('‚ö†Ô∏è Container de produtos relacionados n√£o encontrado'); return; } const labelsData = relatedContainer.querySelector('.post-labels-data'); if (!labelsData) { console.log('‚ö†Ô∏è Labels do post n√£o encontradas'); relatedContainer.innerHTML = '<p style="text-align:center; color:#999; padding:40px;">Nenhum produto relacionado encontrado.</p>'; return; } const labelItems = labelsData.querySelectorAll('.label-item'); if (labelItems.length === 0) { relatedContainer.innerHTML = '<p style="text-align:center; color:#999; padding:40px;">Nenhum produto relacionado encontrado.</p>'; return; } const categoryLabel = labelItems[0].textContent.trim(); console.log('üìÇ Categoria:', categoryLabel); const currentTitle = document.querySelector('.product-info-area h1, h1')?.textContent.trim() || ''; console.log('üìå Post atual:', currentTitle); fetchRelatedPosts(categoryLabel, currentTitle, relatedContainer); } function fetchRelatedPosts(category, currentTitle, container) { const oldScript = document.getElementById('related-feed-script'); if (oldScript) { oldScript.remove(); } const callbackName = 'relatedCallback_' + Date.now(); window[callbackName] = function(data) { try { handleRelatedData(data, currentTitle, container); delete window[callbackName]; } catch (error) { console.error('‚ùå Erro ao processar produtos relacionados:', error); container.innerHTML = '<p style="text-align:center; color:#999; padding:40px;">Erro ao carregar produtos relacionados.</p>'; } }; const script = document.createElement('script'); script.id = 'related-feed-script'; script.src = `/feeds/posts/default/-/${encodeURIComponent(category)}?alt=json-in-script&max-results=9&callback=${callbackName}`; script.onerror = function() { container.innerHTML = '<p style="text-align:center; color:#999; padding:40px;">Erro ao carregar produtos relacionados.</p>'; delete window[callbackName]; }; document.body.appendChild(script); } function handleRelatedData(data, currentTitle, container) { console.log('üì¶ Dados relacionados recebidos:', data); if (!data || !data.feed || !data.feed.entry) { container.innerHTML = '<p style="text-align:center; color:#999; padding:40px;">Nenhum produto relacionado encontrado.</p>'; return; } let posts = data.feed.entry || []; posts = posts.filter(post => { const title = post.title.$t || ''; return title !== currentTitle; }); const screenWidth = window.innerWidth; let maxProducts = 3; if (screenWidth >= 769 && screenWidth <= 1024) { maxProducts = 4; } else if (screenWidth > 1024) { maxProducts = 3; } else { maxProducts = 3; } posts = posts.slice(0, maxProducts); console.log(`‚úÖ ${posts.length} produtos relacionados encontrados (max: ${maxProducts} para tela de ${screenWidth}px)`); if (posts.length === 0) { container.innerHTML = '<p style="text-align:center; color:#999; padding:40px;">Nenhum produto relacionado encontrado.</p>'; return; } container.innerHTML = ''; posts.forEach((post, index) => { setTimeout(() => { renderRelatedProduct(post, container); }, index * 50); }); } function renderRelatedProduct(post, container) { const title = post.title.$t || 'Sem t√≠tulo'; const link = post.link.find(l => l.rel === 'alternate'); const url = link ? link.href : '#'; let imageUrl = 'https: if (post.media$thumbnail && post.media$thumbnail.url) { imageUrl = post.media$thumbnail.url.replace(/s72-c/, 's300'); } const productHTML = ` <article class="product-card" style="animation: fadeIn 0.4s ease;"> <div class="product-image"> <img class="product-thumb" src="${escapeHtml(imageUrl)}" alt="${escapeHtml(title)}" loading="lazy" onerror="this.src='https: <button class="btn-wishlist" onclick="addToWishlist(this)" aria-label="Adicionar aos favoritos"> <i class="far fa-heart"></i> </button> <div class="product-overlay"> <button class="btn-add-cart" data-url="${escapeHtml(url)}" onclick="addToCart(this); openCart();" aria-label="Adicionar ao carrinho"> <i class="fas fa-shopping-cart"></i> <span>Adicionar</span> </button> </div> </div> <div class="product-info"> <h2 class="product-title allow-copy"> <a href="${escapeHtml(url)}">${escapeHtml(title)}</a> </h2> <div class="product-price" data-price="15.00">‚Ç¨15.00</div> </div> </article> `; container.insertAdjacentHTML('beforeend', productHTML); } function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; } })();
