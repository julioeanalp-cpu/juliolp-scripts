(function() { 'use strict'; const CONFIG = { blurAmount: 20, transitionDuration: 300, useIntersectionObserver: 'IntersectionObserver' in window, rootMargin: '50px', threshold: 0.01 }; class ImageOptimizer { constructor() { this.images = []; this.observer = null; this.init(); } init() { if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => this.setup()); } else { this.setup(); } } setup() { this.findImages(); if (CONFIG.useIntersectionObserver) { this.setupIntersectionObserver(); } else { this.loadAllImages(); } } findImages() { const selectors = [ '.product-thumb', '.product-main-image img', '.cart-item-image img', 'img[loading="lazy"]' ]; selectors.forEach(selector => { document.querySelectorAll(selector).forEach(img => { if (!this.images.includes(img)) { this.prepareImage(img); this.images.push(img); } }); }); } prepareImage(img) { img.classList.add('julio-lazy'); if (img.src && !img.classList.contains('loaded')) { img.style.filter = `blur(${CONFIG.blurAmount}px)`; img.style.transition = `filter ${CONFIG.transitionDuration}ms ease`; } img.setAttribute('loading', 'lazy'); if (!img.hasAttribute('onerror')) { img.onerror = function() { this.src = 'https: this.classList.add('loaded'); this.style.filter = 'none'; }; } } setupIntersectionObserver() { this.observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { this.loadImage(entry.target); this.observer.unobserve(entry.target); } }); }, { rootMargin: CONFIG.rootMargin, threshold: CONFIG.threshold }); this.images.forEach(img => this.observer.observe(img)); } loadImage(img) { if (img.complete && img.naturalHeight !== 0) { this.onImageLoad(img); return; } img.addEventListener('load', () => this.onImageLoad(img), { once: true }); } onImageLoad(img) { requestAnimationFrame(() => { img.style.filter = 'none'; img.classList.add('loaded'); }); } loadAllImages() { this.images.forEach(img => this.loadImage(img)); } refresh() { this.findImages(); } } class MobileOptimizer { constructor() { this.isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); this.isSlowConnection = false; this.init(); } init() { this.detectConnection(); this.optimizeForMobile(); } detectConnection() { if ('connection' in navigator) { const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection; if (conn) { this.isSlowConnection = conn.effectiveType === 'slow-2g' || conn.effectiveType === '2g'; conn.addEventListener('change', () => { this.isSlowConnection = conn.effectiveType === 'slow-2g' || conn.effectiveType === '2g'; }); } } } optimizeForMobile() { if (!this.isMobile) return; document.documentElement.style.setProperty('--transition-speed', '0.2s'); document.addEventListener('touchstart', function(){}, {passive: true}); let lastTouchEnd = 0; document.addEventListener('touchend', function(event) { const now = Date.now(); if (now - lastTouchEnd <= 300) { event.preventDefault(); } lastTouchEnd = now; }, false); } shouldReduceQuality() { return this.isMobile && this.isSlowConnection; } } const imageOptimizer = new ImageOptimizer(); const mobileOptimizer = new MobileOptimizer(); window.julioImageOptimizer = imageOptimizer; window.julioMobileOptimizer = mobileOptimizer; if ('MutationObserver' in window) { const observer = new MutationObserver(() => { imageOptimizer.refresh(); }); observer.observe(document.body, { childList: true, subtree: true }); } console.log('âœ¨ JulioLP Image Optimizer carregado'); if (mobileOptimizer.isMobile) { console.log('ðŸ“± OtimizaÃ§Ãµes mobile ativadas'); } })();
